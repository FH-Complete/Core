build_settings:
    verbose: false
    prefer_symlink: false
    ignore:
        - "vendor"
        - "tests"
    pgsql:
        host: 'localhost;dbname=template1'
        user: 'fhcomplete'
        pass: 'fhcomplete'

setup:
    composer:
        action: "install"
        prefer_dist: true
        no_dev: true
    pgsql:
        - "UPDATE pg_database SET datallowconn = 'false' WHERE datname = 'fhctest';" # Stops connections to database
        - "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE pid <> pg_backend_pid() AND datname = 'fhctest';" # Close previous connections to database
        - "DROP DATABASE IF EXISTS fhctest;" # Drops database
        - "CREATE DATABASE fhctest OWNER fhcomplete;" # Creates database
    shell:
        - "rm -f /var/www/html/build" # Remove the previous soft link, if exists, to the build directory
        - "ln -s %BUILD_PATH% /var/www/html/build" # Create a new soft link to the actual build directory
        # Copies configuration files
        - "cp /home/phpci/config/* %BUILD_PATH%/config/"
        # Change database name
        - "sed -i.bak 's/DATABASE fhcomplete/DATABASE fhctest/g' %BUILD_PATH%/system/fhcomplete3.0.sql"
        # Removing the creation of procedural language plpgsql
        - "sed -i.bak 's/CREATE PROCEDURAL LANGUAGE plpgsql;//g' %BUILD_PATH%/system/fhcomplete3.0.sql"
         # Install Database
        - "psql -q -P pager=off -h localhost -U fhcomplete -p 5432 -d fhctest -f %BUILD_PATH%/system/fhcomplete3.0.sql >/dev/null"
#   TODO: This part is not working because of the tbl_benutzerrolle.anmerkung field
#        - "cp /home/phpci/config/version_3.0.php %BUILD_PATH%/version.php"
#        - "wget -qO - 'http://admin:1q2w3@test.fhcomplete.org/build/system/checksystem.php'"
#        - "cp /home/phpci/config/version_3.1.php %BUILD_PATH%/version.php"
#        - "wget -qO - 'http://admin:1q2w3@test.fhcomplete.org/build/system/checksystem.php'"
#        - "cp /home/phpci/config/version_3.2.php %BUILD_PATH%/version.php"
#        - "wget -qO - 'http://admin:1q2w3@test.fhcomplete.org/build/system/checksystem.php'"
        - "cd %BUILD_PATH%/system/ && php dbupdate_3.0.php"
        - "cd %BUILD_PATH%/system/ && php dbupdate_3.1.php"
        - "cd %BUILD_PATH%/system/ && php dbupdate_3.2.php"

test:
#    lint:
#        directories:
#            - "application/"
#        recursive: true
    codeception:
        config: "tests/codeception/"
        path: "tests/codeception/_output/"
#    php_docblock_checker:
#        path: "application/controllers/"
#        allowed_warnings: 100
#        skip_classes: false
#    php_code_sniffer:
#        path: "application/controllers/"
#        standard: "tests/codesniffer/FHComplete"
#        allowed_errors: 200
#        allowed_warnings: 200
#    php_unit:
#        directory: "tests/phpunit/"

complete:
    pgsql:
        - "UPDATE pg_database SET datallowconn = 'false' WHERE datname = 'fhctest';" # Stops connections to database
        - "SELECT pg_terminate_backend(pid) FROM pg_stat_activity WHERE pid <> pg_backend_pid() AND datname = 'fhctest';" # Close previous connections to database
        - "DROP DATABASE IF EXISTS fhctest;" # Drops database
    shell:
        - "rm -f /var/www/html/build" # Remove the previous soft link, if exists, to the build directory